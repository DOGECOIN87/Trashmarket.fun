rules_version = '2';

// Trashmarket.fun Firestore Security Rules (SEC-04)
//
// Deploy with: firebase deploy --only firestore:rules
//
// These rules lock down the database so that:
//  - Only authenticated users can create submissions (max 3 per wallet)
//  - Only admin wallets can approve/reject/delete submissions
//  - Public can read approved submissions only
//  - No one can modify core fields after creation

service cloud.firestore {
  match /databases/{database}/documents {

    // ─── Collection Submissions ──────────────────────────────────────────
    match /submissions/{submissionId} {

      // Anyone can read approved submissions (for the public gallery)
      allow read: if resource == null
                  || resource.data.status == 'approved'
                  || isSubmitter()
                  || isAdmin();

      // Authenticated users can create submissions
      // - Must include required fields
      // - Status must start as 'pending'
      // - submissionCount must be <= 3
      allow create: if request.auth != null
                    && request.resource.data.status == 'pending'
                    && request.resource.data.submittedBy is string
                    && request.resource.data.name is string
                    && request.resource.data.submissionCount <= 3;

      // Only admins can update (approve/reject)
      // Submitters cannot modify their own submissions after creation
      allow update: if isAdmin();

      // Only admins can delete
      allow delete: if isAdmin();
    }

    // ─── Helper functions ────────────────────────────────────────────────

    // Check if the requesting user is the original submitter
    function isSubmitter() {
      return request.auth != null
             && resource.data.submittedBy == request.auth.token.wallet;
    }

    // Check if the requesting user is an admin
    // Admin wallets are stored in a config document
    function isAdmin() {
      return request.auth != null
             && exists(/databases/$(database)/documents/config/admins)
             && request.auth.token.wallet in get(/databases/$(database)/documents/config/admins).data.wallets;
    }

    // ─── Config collection (admin-only) ──────────────────────────────────
    match /config/{docId} {
      allow read: if isAdmin();
      allow write: if false; // Only modifiable via Firebase console or backend
    }

    // ─── Gorbagio NFT Marketplace Listings ────────────────────────────────
    match /gorbagio_listings/{mintAddress} {

      // Anyone can read active listings
      allow read: if true;

      // Authenticated users can create listings (must be the seller)
      allow create: if request.auth != null
                    && request.resource.data.seller is string
                    && request.resource.data.priceSol > 0
                    && request.resource.data.active == true;

      // Only the original seller can update/delete their listing
      allow update: if request.auth != null
                    && resource.data.seller == request.auth.token.wallet;

      allow delete: if request.auth != null
                    && resource.data.seller == request.auth.token.wallet;
    }

    // ─── Deny everything else ────────────────────────────────────────────
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
